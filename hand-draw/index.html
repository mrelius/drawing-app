<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Hand-Tracked Drawing App (Peace-Sign Gesture)</title>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; height:100%; }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%; object-fit:cover;
      transform: scaleX(-1); /* mirror */
    }
    #ui {
      position:absolute; top:10px; left:10px;
      background:rgba(255,255,255,0.8); padding:6px; border-radius:4px;
      display:flex; gap:8px; z-index:10;
    }
    #tutorial {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); color:#fff;
      display:flex; flex-direction:column; align-items:center;
      justify-content:center; text-align:center; padding:20px; z-index:20;
    }
    #tutorial button { margin-top:20px; padding:10px 20px; font-size:16px; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <div id="ui">
    <input type="color" id="colorPicker" value="#000000"/>
    <button id="saveBtn">Save</button>
    <button id="shareBtn">Share</button>
  </div>

  <div id="tutorial" style="display:none;">
    <h1>Welcome!</h1>
    <p>
      1. Allow camera access.<br>
      2. Center your hand in view.<br>
      3. Show a peace sign (✌️) to draw.<br>
      4. Make a fist to pause.
    </p>
    <button id="tutorialBtn">Got it!</button>
  </div>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <script>
    const video       = document.getElementById('video'),
          canvas      = document.getElementById('canvas'),
          ctx         = canvas.getContext('2d'),
          colorPicker = document.getElementById('colorPicker'),
          saveBtn     = document.getElementById('saveBtn'),
          shareBtn    = document.getElementById('shareBtn'),
          tutorial    = document.getElementById('tutorial'),
          tutBtn      = document.getElementById('tutorialBtn');

    let drawing = false, lastPos = null, strokeColor = colorPicker.value;

    function isPeaceSign(lm) {
      // index tip above PIP AND middle tip above PIP
      return lm[8].y < lm[6].y && lm[12].y < lm[10].y
        // ring & pinky curled
        && lm[16].y > lm[14].y && lm[20].y > lm[18].y;
    }
    function isFist(lm) {
      // all fingertips below their PIPs
      return [8,12,16,20].every(i => lm[i].y > lm[i-2].y);
    }

    function onResults(results) {
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if (results.multiHandLandmarks.length > 0) {
        const lm = results.multiHandLandmarks[0];

        if (isPeaceSign(lm)) {
          drawing = true;
        } else if (isFist(lm)) {
          drawing = false;
          lastPos = null;
        }

        const x = (1 - lm[8].x) * canvas.width;
        const y = lm[8].y * canvas.height;

        // debug dot
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, 2 * Math.PI);
        ctx.fill();

        if (drawing) {
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth   = 4;
          ctx.lineCap     = 'round';
          if (lastPos) {
            ctx.beginPath();
            ctx.moveTo(lastPos.x, lastPos.y);
            ctx.lineTo(x, y);
            ctx.stroke();
          }
          lastPos = { x, y };
        }
      } else {
        drawing = false;
        lastPos = null;
      }
    }

    const hands = new Hands({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });
    hands.setOptions({
      maxNumHands:           1,
      modelComplexity:       1,
      minDetectionConfidence:0.8,
      minTrackingConfidence: 0.8
    });
    hands.onResults(onResults);

    const camera = new Camera(video, {
      onFrame: async () => await hands.send({ image: video }),
      width:  640,
      height: 480
    });
    camera.start();

    colorPicker.addEventListener('input', e => strokeColor = e.target.value);
    saveBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'drawing.png';
      link.href     = canvas.toDataURL('image/png');
      link.click();
    });
    shareBtn.addEventListener('click', async () => {
      const dataUrl = canvas.toDataURL('image/png');
      if (navigator.canShare?.({ files: [] })) {
        const blob = await (await fetch(dataUrl)).blob();
        const file = new File([blob],'drawing.png',{type:'image/png'});
        navigator.share({ files:[file], title:'My Sketch' });
      } else {
        navigator.clipboard.writeText(dataUrl);
      }
    });

    window.addEventListener('load', () => {
      if (!localStorage.getItem('tutorialSeen')) tutorial.style.display = 'flex';
    });
    tutBtn.addEventListener('click', () => {
      tutorial.style.display = 'none';
      localStorage.setItem('tutorialSeen','true');
    });
  </script>
</body>
</html>
